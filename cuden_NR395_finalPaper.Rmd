---
title: "New England Forest Composition at the time of European Settlement"
author: "Charlotte Uden"
date: "5/10/2019"
output:
  html_document:
    df_print: paged
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

[*Back to index*](Index.html)

###Introduction

Humans have been shaping the landscape for thousands of years (Sadori L. 2010). We now know that native american populations in the americas were expansive and their impact on the landscape was significant (Denevan, William M. 1992). Projecting forest composition at the time of settlement may offer some indication of the extent of Native American land use practices. Ultimately, the goal is to use LPJ-GUESS, a dynamic vegetation model, to predict species composition in new england at the time of european settlement. 


###Dataset

The model will be run with and without fire disturbance and its output compared with two datasets:

  1. Forest Inventory Analysis (FIA): a survey conducted by the united states forest service. This dataset will provide a comparison for current species composition. This dataset will not be included in this analysis.*

  2. Witness trees: used by surveyors at the time of european settlement to mark property boundaries. Charlie Cogbill has compiled these records from towns across New England (Cogbill, C.V. 2002). This dataset will be compared with the model output for composition approximately 350 years ago (dates of surveys vary). 

```{r, echo=FALSE, results='hide',message=FALSE}
wit <- read.csv("witness tree /583NewEngland%.csv")
library(mapdata)
library(maps)
library(ggplot2)
library(dplyr)
```

```{r, include=FALSE}
states <- map_data("state")#turn state line map into data frame
new_england <- subset(states, region %in% c("vermont", "new hampshire", "connecticut", "maine", "rhode island", "massachusetts"))#subest new england states
```

```{r}
ggplot() + 
  geom_polygon(data = new_england, aes(x=long, y = lat, group = group)) +
  coord_fixed(1.3) +
  geom_point(data=wit, aes(x=Long.,y=Lat.))

```

A important assumption to note is that these trees were surveyed before settlement had begun. If this is the case, then these trees are part of a landscape not yet impacted by european land use practices such as logging and agriculture. Surveys span 200 years, from 1620 (Connecticut and Rhode Island) to 1850 (parts of New Hampshire). Only trees with defined points are included in the dataset, not general mentions of species composition. In many cases, linnaean classification had not yet been introduced at the time of the survey, so tree names are sited by their common name (which also differs from current common names). There are 583 data points. Each point corresponds to a town. Its latitude, longitude (the center most point of the town), number of trees recorded and proportions by genus. Oak, hickory, chestnut  and Spruce meet their northern and southern range limits. A detrended correspondence analysis and cluster analysis was performed on the dataset. Eight forest types were found, with beech dominating to the north and oak to the south. 

This analysis aims to fit a rarefaction curve to the witness tree dataset. Rarefaction curves, or species accumulation curves, relate species richness to sample size (Fisher, R. A. 1943, Ugland, K. I. 2003). As the number of individuals you sample from a community increases, so does the likelihood of sampling a new species. Because richness is finite, the rarefaction curve eventually flattens, indicating that no additional sampling will yield a new species. Rarefaction curves are often used to estimate species richness in hyperdiverse clades or communities not easily accessible (Colwell, R. K. 1994). In a similar way, access to historic community richness data is limited. This curve could be used to identify sample points (towns) in the witness tree dataset that offer a true representation of forest species composition at the time of settlement. For example, data points that do not meet the minimum sample size needed to yield maximum richness (x value at which the curve flattens) will not be compared with the LPJ-GUESS output.


###Analysis

Richness was calculated for each data point and plotted against sample size. Sample size was log transformed in part to fit a linear model, but also because sample size varies so much -from 46 to 4477 trees. 

```{r, echo=FALSE, results='hide',message=FALSE}
#add column of tallies for species richness
library(expss)
library(patchwork)
  wit  <- modify(wit, {
    richness = count_row_if(gt(0), wit[7:30])
  })
head(wit)
rich_base <- ggplot(wit, aes(x=Trees, y=richness)) +
  geom_point() +
  theme_bw(base_size=14) +
  xlab("Sample Size") +
  ylab("Species Richness")
```


```{r, echo=FALSE, results='hide', message=FALSE}
#hist(wit$Trees, xlab="Sample Size", main=NULL) #sample sizes range hugely 
#min(wit$Trees)
#max(wit$Trees)

#log transform Trees (sample size)
wit <- mutate(wit, logTrees=log(Trees))

rich_log_base <- ggplot(wit, aes(x=logTrees, y=richness)) +
  geom_point() +
  theme_bw(base_size=14) +
  xlab("log Sample Size") +
  ylab("Species Richness")

rich_base + rich_log_base 
```

Model 1 fits the data using simple linear regression. Plotting observed against fitted values of richness indicates positive bias for smaller values of richness, and low bias for higher values of richness. Error is evenly dispersed around 0. However, it decreases slightly as both richness and sample size increase. This could be explained by richness being finite: when sample size is large enough, richness will become constant. At this point, more accurate predictions can be made about richness and error will decrease. Residuals are normally distributed. 


```{r}
Mod1 <- lm(richness~logTrees, data=wit) #fit simple linear regression

#model checks

#save normalized residuals and predicteds
M1Res <- resid(Mod1)
M1Pred <- predict(Mod1)

#Model fit 
#plot observed vs fitted values + 1:1 line

obs_fit_1 <- ggplot(wit, mapping=aes(x=M1Pred, y=richness)) + geom_point() + xlab("Observed Richness") + ylab("Fitted Richness") + geom_abline(slope=1)

#Homogeneous error distribution
#Residuals vs fitted

Res_Pred_1 <- ggplot(wit, mapping=aes(x=M1Pred, y=M1Res)) + geom_point() + xlab("Predicted Richness") + ylab("Residuals") 
#error decreases with predicted values for richness

#Normality
#Residuals vs X 

Res_X_1 <- ggplot(wit, mapping=aes(x=logTrees, y=M1Res)) + geom_point() + xlab("log Sample Size") + ylab("Residuals") #error decreases with sample size

obs_fit_1 + Res_Pred_1 + Res_X_1

par(mfrow=c(1,2))

#Q-Q plot
qqnorm(M1Res, main="Model 1")
qqline(M1Res)#not bad
#histogram of residuals
hist(M1Res, xlab="Model 1 Residuals", main=NULL) #also good.
```

The relationship between species richness and latitude is a global phenomenon seen in a number of taxa, including vascular plants (Hildebrand, H 2004). This latitudinal diversity gradient is maintained at regional levels. Therefore, there is good reason to expect a similar mechanism at play in this dataset. A bubble plot and variogram can be used to check for spatial autocorrelation.

Both the bubble plot and variogram generated for Model 1 indicate spatial autocorrelation. The bubble plot shows clumping of residuals; similar size (amount of error) and color (negative or positive error) bubbles are located near each other. The variogram illustrates a sill (y value at which variance plateaus) at 6.5, a range (distance between 2 points at which autocorrelation is lost) at 2.5 and a nugget (the y intercept, or where points are closest to each other) at 3.5. If no spatial correlation exists, then all values for variance will be equal -no matter how far apart points are, variation is the same. The variogram would be flat with a sill is at 1. 


```{r}
#look for spatial autocorrelation

library(gstat)
library(sp)
#make data frame with residuals, x, y coordinates
mydata1<-data.frame(M1Res, wit$Lat.,wit$Long.)

#ensure the bubble fcn knows what the x and y spatial coordinates are.
coordinates(mydata1) <- c("wit.Lat.", "wit.Long.")

#make the bubble plot
bubble1 <- bubble(mydata1, "M1Res", col=c("black", "gray"), main="Model 1 Residuals", xlab="c-coordinates", ylab="y-coordinates")
bubble1
#black dots are negative residuals, grey dots are positive residuals. Want residuals that are similar value (pos, neg, large, small) to be spatially clumped togehter -this means that error is to do with whatever is going on in that specififc place -and so you can account for this in your data!

#make a variogram:
bound <- seq(from=0, to=20, by=0.5)
Vario1 <- variogram(M1Res~1, boundaries=bound,mydata1)
plot(Vario1, main="Model 1 Variogram")

```

Model 2 fits the data using generalized least squares. The intention here is to us the correlation function to account for spatial autocorrelation in the data. Due to the abnormal shape of the variogram for model 1, choosing a correlation structure is difficult. So, models 2, 3, 4 and 5 are all fitted using generalized least squares, each with a different correlation structure: 

  * Model 2: exponential correlation (corEXp)
  
  * Model 3: exponential correlation with the range and nugget specified 
  
  * Model 4: rational quadratic correlation (corRatio)
  
  * Model 5: gaussian correlation (corGaus)

Finally, Model 6 was fit using a general linear model with a poisson error distribution. Sample size is count data, so a poisson error distribution seems like a reasonable parameter to add. As you increase counts (sample size), you would expect to find more variance in the data. However, Model 2 has the lowest AIC value; at this point, an exponential correlation structure provides the best fit. Counter to its improved AIC score, model checks don't look particularly different from Model 1. The variogram is almost identical and error still decreases with observed richness, predicted richness and sample size. 



```{r, echo=FALSE, results='hide', message=FALSE}

#-------fit with gls--------------

library(nlme)
Mod2 <-gls(richness~logTrees, correlation=corExp(form=~Lat.+Long., nugget=TRUE), data=wit) #generaized least squares

summary(Mod2) 

#add range (0.7363776) and nugget (0.3908667) to model
Mod3 <-gls(richness~logTrees, correlation=corExp(c(0.7363776, 0.3908667), form=~Lat.+Long., nugget=TRUE), data=wit)

#Rational quadratic correlation
Mod4 <- gls(richness~logTrees, correlation=corRatio(form=~Lat.+Long., nugget=TRUE), data=wit)

#Gaussian (normal) correlation
Mod5 <- gls(richness~logTrees, correlation=corGaus(form=~Lat.+Long., nugget=TRUE), data=wit)

#General linear model, poission error distribution. 
Mod6 <- glm(richness~log(Trees), data=wit, family=poisson(link="log"))

AIC(Mod1, Mod2, Mod3, Mod4, Mod5, Mod6) #mod2 still the best, but mod4 is close. corRatio -a rational quadratic correlation structure
```


```{r, echo=FALSE, results='hide', message=FALSE}
# make bubble plot and variogram for the best model so far: Mod2
M2Res <- resid(Mod2)
M2Pred <- predict(Mod2)
#data frame of residuals, lat and long
mydata2<-data.frame(M2Res, wit$Lat.,wit$Long.)
#ensure the bubble fcn knows what the x and y spatial coordinates are.
coordinates(mydata2) <- c("wit.Lat.", "wit.Long.")
#bubble plot
bubble2 <- bubble(mydata2, "M2Res", col=c("black", "gray"), main="Model 2 Residuals", xlab="c-coordinates", ylab="y-coordinates")
library(patchwork)
#make a variogram:
Vario2 <- variogram(M2Res~1, boundaries=bound, mydata2)
#plot(Vario2)
#they look the exact same...

#Model fit 
#plot observed vs fitted values + 1:1 line
obs_fitted_mod2 <- qplot(richness, M2Pred, data=wit, xlim=c(0,20), ylim=c(0,20)) + geom_abline(slope=1) #looks okay, but not sure if its okay to change axis...what 

#Homogeneous error distribution
#Residuals vs fitted
ResPred2 <- qplot(M2Pred,M2Res)
#error STILL decreases with predicted values for richness

#Normality
#Residuals vs X 
res_X_mod2 <- qplot(wit$logTrees, M2Res, main="residuals for Mod2 vs Sample Size")#error decreases with sample size

#Q-Q plot
#par(mfrow=c(1,1))
#qqnorm(M1Res)
#qqline(M1Res)#not bad

#histogram of residuals
#hist_M2res <- hist(M1Res) 
```


```{r, echo=FALSE, message=FALSE}
library(patchwork)

map_richness <- ggplot(wit, mapping=aes(x=Long., y=Lat., color=richness)) +
  geom_point(size=4, alpha=0.9) + 
  ggtitle("Richness") +
  scale_color_gradient(low="yellow",high="blue")

map_sample <- ggplot(wit, mapping=aes(x=Long., y=Lat., color=logTrees)) +
  geom_point(size=4, alpha=0.9) + 
  ggtitle("Sample Size") +
  scale_color_gradient(low="yellow",high="blue")

map_richness + map_sample
```

So, why does adding a spatial correlation structure not improve error? When richness is mapped, there is a fairly clear gradient of high richness to the south and low richness to the north. This map aligns nicely with the latitudinal gradient hypothesis. Either that, or some environmental factor limits species diversity to the north. However, when sample size is mapped, we see a similar pattern -large sample sizes to the north and small to the south. The assumption that environment determines richness found in this dataset becomes unclear. Incorporating environmental parameters, such as temperature or soil data, could help tease out this sample size-richness-latitude interaction. 

There are no environmental variables in this dataset, so including this parameter is not an immediate option. However, adding state as a factor might deal with correlation between sample size and latitude. Surveying techniques, for example, may differ between states -some favoring the use of witness trees and others preferring stakes or boulders. Further, if richness was in fact lower to the north, forest composition would be more homogenous. Finding one witness tree amongst thousands of identical trees would be far more difficult than in a more diverse stand of trees. So, Model 7 uses the varIdent() function to account for difference in variance for each state. Spatial autocorrelation is still incorporated into the model. 


```{r, echo=FALSE, message=FALSE}
#make state a factor
wit <- mutate(wit, fState=factor(wit$Ver..2010.09))

Mod7 <- gls(richness~logTrees, 
            correlation=corExp(form=~Lat.+Long., nugget=TRUE), #spatial autocorrelation
            weights=varIdent(form=~1|fState), #adjust for difference in variance for each state. 
            data=wit)

AIC(Mod2, Mod7)
```

Model 7 has a lower AIC score to Model 2. When residuals are plotted by state, error for model 7 has less spread and clumps closer to 0 than error for model 2. When observed richness is plotted against fitted richness, bias has become slightly more positive -points follow the 1:1 line more closely. Error still increases slightly with observed and fitted richness, as well as sample size, but remains normally distributed. The bubble plot and variogram for model 7 both indicated that spatial autocorrelation has been reduced. Bubbles are no longer clumped by size and color. The variogram now has a sill at 1, indicating that error is independent from distance between towns (sample points). 

```{r, echo=FALSE, message=FALSE}
M7Res <- resid(Mod7, type="normalized")
M7Pred <- predict(Mod7)

#data frame of states and residuals for models 2 and 7
df <- data.frame(wit$fState, M2Res, M7Res)

library(reshape2)
#melt so that residuals are a column and hten can plot both on same plot
dat.m <- melt(df,id.vars='wit.fState', measure.vars=c('M2Res','M7Res'))

#plot illustrates varIdent dealing with variance by state. So, spread of residuals is smaller, and means are all close to 0. 
ggplot(dat.m) + 
  geom_boxplot(aes(x=wit.fState, y=value, color=variable)) +
  xlab("State") + ylab("Residuals") + ggtitle("Comparison of Residuals for Models 2 and 7")
  
  
#make a bubble plot for model 7:
mydata7 <- data.frame(M7Res, wit$Lat.,wit$Long.)
#ensure the bubble fcn knows what the x and y spatial coordinates are.
coordinates(mydata7) <- c("wit.Lat.", "wit.Long.")
#bubble plot
bubble7 <- bubble(mydata7, "M7Res", col=c("black", "gray"), main="Model 7 Residuals", xlab="c-coordinates", ylab="y-coordinates")
bubble7
#bubble2 #compare with Mod2. Could argue that residuals got smaller.

library(patchwork)
#make a variogram:
Vario7 <- variogram(M7Res~1, boundaries=bound, mydata7, main="Model 7 Variogram")
#plot(Vario2, main="variogram for Model 2")
plot(Vario7, main="Model 7 Variogram")

    #Model Checks

#Model fit 
#plot observed vs fitted values + 1:1 line
obs_fit_7 <- ggplot(wit, mapping=aes(x=M7Pred, y=richness)) + geom_point() + xlab("Observed Richness") + ylab("Fitted Richness") + ggtitle("Model 7") + geom_abline(slope=1)

#Homogeneous error distribution
#Residuals vs fitted
Res_Pred_7 <- ggplot(wit, mapping=aes(x=M7Pred, y=M7Res)) + geom_point() + xlab("Fitted Richness") + ylab("Residuals") 

#Normality
#Residuals vs X 
Res_X_7 <- ggplot(wit, mapping=aes(x=logTrees, y=M7Res)) + geom_point() + xlab("log Sample Size") + ylab("Residuals") 

par(mfrow=c(1,3))
obs_fit_7 + Res_Pred_7 + Res_X_7

#Q-Q plot
par(mfrow=c(1,2))
qqnorm(M1Res)
qqline(M1Res)

#histogram of residuals
hist(M7Res, xlab="Model 7 Residuals", main=NULL)
```


###Discussion

```{r, echo=FALSE, results='hide', message=FALSE}
#summary(Mod7)
sampleSize <- seq(0,4000) 
Richness <- 0.59 + 1.8223605*log(sampleSize)
plot(Richness~sampleSize, main="Rarefaciton Curve", xlab="Sample Size")
```

$$richness=0.59 + 1.8223605*log(sampleSize) $$
 
The slope for log sample size is 1.82. This represents the proportional increase in richness for each increase in sample size. The intercept is at 0.59. However, when sample size is 0, richness should be 0. Furthermore richness is an integer -there is no such thing as a fraction of a species. Despite these flaws in the model, the goal of this analysis can still be achieved. The rarefaction curve provides some insight into which towns provide a large enough sample size to report an accurate measure of richness. 


###References

1. Cogbill, C. V., Burk, J., & Motzkin, G. (2002). The forests of presettlement New England, USA: Spatial and compositional patterns based on town proprietor surveys. Journal of Biogeography. https://doi.org/10.1046/j.1365-2699.2002.00757.x
2. Ugland, K. I., Gray, J. S., & Ellingsen, K. E. (2003). The species-accumulation curve and estimation of species richness. Journal of Animal Ecology. https://doi.org/10.1046/j.1365-2656.2003.00748.x
3. Fisher, R. A., Steven-Corbet, A., & Williams, C. B. (1943). The Relation Between the Number of Species and the Number of Individuals in a Random Sample of an Animal. Journal of Animal Ecology.
4. Smith, B., Prentice, I. C., & Sykes, M. T. (2001). Representation of vegetation dynamics in the modelling of terrestrial ecosystems: Comparing two contrasting approaches within European climate space. Global Ecology and Biogeography. https://doi.org/10.1046/j.1466-822X.2001.00256.x
5. Colwell, R. K., & Coddington, J. A. (1994). Estimating terrestrial biodiversity through extrapolation. Philosophical Transactions of the Royal Society of London. Series B, Biological Sciences. https://doi.org/10.1098/rstb.1994.0091
6. Chazdon, R. L., Colwell, R. K., Denslow, J. S., & Guariguata, M. R. (1998). Statistical methods for estimating species richness of woody regeneration in primary and secondary rainforests of northeastern Costa Rica. In Forest biodiversity research, monitoring and modeling: Conceptual background and Old World case studies.
7. Birks, H. J. B., & Line, J. M. (1992). The use of Rarefaction Analysis for Estimating Palynological Richness from Quaternary Pollen-Analytical Data. The Holocene. https://doi.org/10.1177/095968369200200101
8. Denevan, W. M. (1992). The Pristine Myth: The Landscape of the Americas in 1492. Annals of the Association of American Geographers. https://doi.org/10.1111/j.1467-8306.1992.tb01965.x
9. Stevens, G. C. (2002). The Latitudinal Gradient in Geographical Range: How so Many Species Coexist in the Tropics. The American Naturalist. https://doi.org/10.1086/284913
10. Hillebrand, H. (2004). On the Generality of the Latitudinal Diversity Gradient. The American Naturalist. https://doi.org/10.1086/381004
11. Sadori, L., Mercuri, A. M., & Lippi, M. M. (2010). Reconstructing past cultural landscape and human impact using pollen and plant macroremains. Plant Biosystems. https://doi.org/10.1080/11263504.2010.491982
